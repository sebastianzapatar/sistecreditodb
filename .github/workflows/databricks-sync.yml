name: Sync to Databricks on Push

on:
  push:
    branches: [ main ]

jobs:
  sync-databricks:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Update Databricks Repo via API
      run: |
        echo "üîÑ Syncing with Databricks..."
        
        # Obtener lista de repos
        REPOS_RESPONSE=$(curl -s -X GET \
          "${{ secrets.DATABRICKS_HOST }}/api/2.0/repos" \
          -H "Authorization: Bearer ${{ secrets.DATABRICKS_TOKEN }}")
        
        echo "üìã Repos found:"
        echo "$REPOS_RESPONSE" | jq -r '.repos[].path'
        
        # Buscar nuestro repo espec√≠fico
        REPO_ID=$(echo "$REPOS_RESPONSE" | jq -r '.repos[] | select(.path=="/Workspace/Users/pansezapata@gmail.com/sistecreditodb") | .id')
        
        if [ "$REPO_ID" != "null" ] && [ -n "$REPO_ID" ]; then
          echo "‚úÖ Found repo ID: $REPO_ID"
          
          # Actualizar a branch main
          curl -X PATCH \
            "${{ secrets.DATABRICKS_HOST }}/api/2.0/repos/$REPO_ID" \
            -H "Authorization: Bearer ${{ secrets.DATABRICKS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"branch": "main"}' \
            --fail-with-body
          
          echo "‚úÖ Databricks repo synced successfully!"
        else
          echo "‚ùå Repo not found with path /Workspace/Users/pansezapata@gmail.com/sistecreditodb"
          exit 1
        fi
