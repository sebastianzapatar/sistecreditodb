name: Sync to Databricks on Push

on:
  push:
    branches: [ main ]

jobs:
  sync-databricks:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Update Databricks Repo
      run: |
        echo "üîÑ Updating sistecreditodb repo..."
        
        # Usar el ID exacto del repo que encontramos
        REPO_ID="4472650222095333"
        
        echo "üìç Using repo ID: $REPO_ID"
        
        # Actualizar repo directamente con el ID conocido
        UPDATE_RESPONSE=$(curl -s -w "%{http_code}" -X PATCH \
          "${{ secrets.DATABRICKS_HOST }}/api/2.0/repos/$REPO_ID" \
          -H "Authorization: Bearer ${{ secrets.DATABRICKS_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"branch": "main"}')
        
        HTTP_CODE="${UPDATE_RESPONSE: -3}"
        RESPONSE_BODY="${UPDATE_RESPONSE%???}"
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "‚úÖ Databricks repo synced successfully!"
          echo "üìä Response: $RESPONSE_BODY"
        else
          echo "‚ùå Update failed with HTTP $HTTP_CODE"
          echo "üîç Response: $RESPONSE_BODY"
          exit 1
        fi
